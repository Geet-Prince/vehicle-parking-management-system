{# ======================================================== #}
{# START OF FULL CODE FOR: templates/user/book_spot.html #}
{# ======================================================== #}

{% extends "user/base_user.html" %}

{% block title %}Book Spot at {{ lot.name }}{% endblock %}

{% block content %}
<h2>Book a Parking Spot at {{ lot.name }}</h2>
<p><strong>Location:</strong> {{ lot.location }}</p>

{# --- Display Current Availability --- #}
<h3>Current Availability (Approx.)</h3>
{% if availability %}
    <p>Total Spots Currently Occupied: {{ total_booked }}</p>
    <ul>
        {# Using details from the availability dictionary passed from Flask #}
        <li>Ground Floor (2W): {{ availability['0'].available }} / {{ availability['0'].capacity }} available</li>
        <li>Floor 1 (4W): {{ availability['1'].available }} / {{ availability['1'].capacity }} available</li>
        <li>Floor 2 (4W): {{ availability['2'].available }} / {{ availability['2'].capacity }} available</li>
    </ul>
    <p><small><em>Note: Availability is approximate and checked again upon booking submission.</em></small></p>
{% else %}
    {# Fallback message if availability couldn't be loaded #}
    <p class="alert alert-warning">Could not retrieve current availability information.</p>
{% endif %}


{# --- Booking Form --- #}
<h3>Booking Details</h3>

{# This form tag needs the correct 'action' attribute.
   It must point to the URL generated by url_for for the 'user_submit_booking' function.
   The method MUST be "post".
#}
<form method="post" action="{{ url_for('user_submit_booking', lot_id=lot.id) }}" class="form-container">

    {# Vehicle Type Selection #}
    <div class="form-group">
        <label for="vehicle_type">Vehicle Type:</label>
        <select id="vehicle_type" name="vehicle_type" required>
            <option value="" disabled selected>-- Select Type --</option> {# Default placeholder option #}
            <option value="2W">2-Wheeler (Ground Floor)</option>
            <option value="4W">4-Wheeler (Floors 1 or 2)</option>
        </select>
    </div>

    {# Vehicle Registration Input #}
    <div class="form-group">
        <label for="vehicle_reg_number">Vehicle Registration Number:</label>
        <input type="text" id="vehicle_reg_number" name="vehicle_reg_number" required pattern="[A-Za-z0-9\s-]+" title="Use letters, numbers, spaces, hyphens" placeholder="e.g., DL 1 C AB 1234">
    </div>

    {# Start Time Input #}
    <div class="form-group">
        <label for="start_time">Parking Start Time:</label>
        <input type="datetime-local" id="start_time" name="start_time" required>
    </div>

    {# End Time Input #}
    <div class="form-group">
        <label for="end_time">Parking End Time:</label>
        <input type="datetime-local" id="end_time" name="end_time" required>
    </div>

    {# Submit Button #}
    <button type="submit" class="btn">Find Spot & Book</button>
</form>
{# --- End of Form --- #}


{# --- Optional JavaScript for Date Input Validation --- #}
{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get current time adjusted for timezone and add a small buffer (e.g., 1 minute)
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset() + 1); // Local time + 1 min buffer
        now.setSeconds(0); // Optional: Clear seconds/milliseconds for cleaner input step
        now.setMilliseconds(0);
        // Format for datetime-local input's 'min' attribute (YYYY-MM-DDTHH:mm)
        const minDateTime = now.toISOString().slice(0, 16);

        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');

        // Set minimum allowed datetime for both inputs
        if (startTimeInput) startTimeInput.min = minDateTime;
        if (endTimeInput) endTimeInput.min = minDateTime;

        // Function to validate that end time is after start time
        function validateEndTime() {
            // Ensure both elements exist and have values before comparing
            if (startTimeInput && endTimeInput && startTimeInput.value && endTimeInput.value) {
                const startDt = new Date(startTimeInput.value);
                const endDt = new Date(endTimeInput.value);

                if (endDt <= startDt) {
                    // Set a custom validation message if end time is not after start time
                    endTimeInput.setCustomValidity("End time must be after start time.");
                } else {
                    // Clear the custom validation message if the times are valid
                    endTimeInput.setCustomValidity("");
                }
            } else if (endTimeInput) {
                // Clear validation if start time is missing (let 'required' handle that)
                endTimeInput.setCustomValidity("");
            }
        }

        // Add event listeners to re-validate whenever either input changes
        if (startTimeInput) startTimeInput.addEventListener('input', validateEndTime);
        if (endTimeInput) endTimeInput.addEventListener('input', validateEndTime);
    });
</script>
{% endblock %} {# End scripts_extra block #}

{% endblock %} {# End content block #}

{# ======================================================== #}
{# END OF FULL CODE FOR: templates/user/book_spot.html   #}
{# ======================================================== #}